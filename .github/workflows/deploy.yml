name: Python package

env:
  UV_LINK_MODE: copy

on:
  push:
  pull_request:
    types: [ opened, edited ]
  workflow_dispatch:

jobs:
  build-dists:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]
        python:
          - {version: '3.12'}
          - {version: '3.13'}
          - {version: '3.14'}
        nextcord:
          - {NAME: 'pypi', PIP_TARGET: 'nextcord[voice]'}
          - {NAME: 'git', PIP_TARGET: 'nextcord[voice] @ git+https://github.com/nextcord/nextcord@master'}
    name: "${{ matrix.os }} CPython ${{ matrix.python.version }} with ${{ matrix.nextcord.NAME }} nextcord"
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python.version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python.version }}

    - name: Set up uv
      uses: astral-sh/setup-uv@v7
      with:
        version: '0.9.18'

    - name: Install dependencies
      shell: bash
      run: |
        uv sync --no-install-project --all-extras
        uv pip install -U "${{ matrix.nextcord.PIP_TARGET }}"

    - name: Test from local directory
      shell: bash
      run: |
        uv run --no-sync pytest -vs --cov=ncjishaku --cov-report term-missing:skip-covered

    - name: Lint repository
      shell: bash
      run: |
        uv run --no-sync ruff check

    - name: Create distributions and install wheel
      shell: bash
      run: |
        export tag_name="${GITHUB_REF##*/}"

        # Substitute README assets with direct GitHub links
        sed -i'.original' -e "s@src=\".github/assets@src=\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/raw/$GITHUB_SHA/.github/assets@g" README.md
        rm -f README.md.original

        uv build
        rm -rf ncjishaku
        find dist -name *.whl -exec uv pip install '{}' +

    - name: Test from installed module
      shell: bash
      run: |
        uv run --no-sync pytest -vs

    - name: Build documentation
      shell: bash
      run: |
        cd docs && UV_NO_SYNC=1 make html

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: distributions-${{ matrix.os }}-${{ matrix.python.version }}-${{ matrix.nextcord.NAME }}
        path: dist/*

  upload-pypi:
    needs: [ build-dists ]
    runs-on: ubuntu-latest
    environment: publish
    permissions:
      # Required to create release
      contents: write
      # Required for OIDC
      id-token: write
    if: github.event_name == 'push' && startsWith(github.event.ref, 'refs/tags/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Set up Python 3.14
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'  # Watch as I let this get handled as a float again

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          version: '0.9.18'

      - name: Install dependencies
        shell: bash
        run: |
          sudo apt-get update && sudo apt-get install -y hub
          uv sync --no-editable --extra publish

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          # There is currently a bug where download-artifact downloading multiple files of the same name corrupts the file.
          # https://github.com/actions/download-artifact/issues/298
          # Very cool.
          # We don't have any native code so using the latest Ubuntu artifact should be OK.
          #pattern: distributions-*
          pattern: distributions-ubuntu-latest-3.14-pypi
          merge-multiple: true
          path: dist

      - name: Publish wheels as release artifacts on GitHub
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -x
          export tag_name="${GITHUB_REF##*/}"
          uv run python create_dist_summary.py
          assets=()
          for asset in ./dist/*.{whl,tar.gz}; do
            assets+=("-a" "$asset")
          done
          hub release create "${assets[@]}" -F ./dist/DIST_SUMMARY.md "$tag_name"
          rm ./dist/*.md

      - name: Publish packages to PyPI
        shell: bash
        env:
          PYPI_TOKEN: ${{ secrets.TEST_PYPI_TOKEN }}
        run: uv publish --publish-url 'https://test.pypi.org/legacy/' --token "$PYPI_TOKEN"
